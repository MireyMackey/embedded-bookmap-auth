<!DOCTYPE html>
<html>
<head>
    <title>BMMP embedding example</title>
</head>
<body>

<h1>Bookmap Web Widget embedding example</h1>

<label for="limeToken">Enter lime token: </label>
<input type="text" id="limeToken"/><br>
<br>

<button id="fetchTokenButton">Send Request</button>
<div id="tokenFetchResult"></div>
<br>

<button id="passTokenButton">Pass token to iframe</button>
<div id="tokenPassResult"></div>
<br>

<div style="width: 900px; height: 400px;" id="BMMP"></div>

<script>
  let bookmapToken = '';

  document.getElementById('fetchTokenButton').addEventListener('click', getToken);
  document.getElementById('passTokenButton').addEventListener('click', passToken);

  // Auto-execute on page load
  document.addEventListener('DOMContentLoaded', () => {
    getToken().then(() => {
      passToken();
    });
  });

  function getLimeToken() {
    const tokenInput = document.getElementById('limeToken');
    return tokenInput.value.trim();
  }

  async function getToken() {
    const resultDiv = document.getElementById('tokenFetchResult');
    const limeToken = getLimeToken();
    if (!limeToken) {
      resultDiv.textContent = 'Please enter a Lime token first.';
      return;
    }

    try {
      resultDiv.textContent = 'Sending request...';

      const response = await fetch("https://test.x-bookmap.com/api/v2/auth/token", {
        method: "POST",
        body: JSON.stringify({
          partnerName: 'lime',
          token: limeToken
        }),
        headers: {
          "Content-type": "application/json",
        }
      });

      if (!response.ok) {
        resultDiv.textContent = `HTTP error. status: ${response.status}`;
        return;
      }
      bookmapToken = await response.text();
      resultDiv.textContent = bookmapToken;
    } catch (error) {
      resultDiv.textContent = `Error: ${error.message}`;
    }
  }

  async function passToken() {
    const resultDiv = document.getElementById('tokenPassResult');
    if (!bookmapToken) {
      resultDiv.textContent = 'Please fetch a token first.';
      return;
    }

    const bmmp = createIframe("https://usl098.int.bookmap.com/", bookmapToken, { instrument: 'ADA-USDT:MULTIBOOK:SPOT', width: "1000px" });
    const iframeDiv = document.getElementById('BMMP');
    while (iframeDiv.firstChild) {
      iframeDiv.removeChild(iframeDiv.firstChild);
    }
    iframeDiv.append(bmmp);

    resultDiv.textContent = 'Token sent';
  }

  const defaultOptions = {
    width: '100%',
    height: '100%',
  };

  /**
   * Creates an iframe of Bookmap Web
   * @param url - URL of the Bookmap Web to connect to
   * @param token - Authentication token
   * @param [options] - Optional configuration options
   * @returns Created iframe element
   */
  function createIframe(url, token, options) {
    const mergedOptions = Object.assign(Object.assign({}, defaultOptions), options);
    const iframe = document.createElement('iframe');
    console.info("Creating iframe with options:", mergedOptions);
    iframe.src = url;
    iframe.style.cssText = `
      width: ${mergedOptions.width};
      height: ${mergedOptions.height};
      border: 0;
    `;
    iframe.addEventListener('load', () => {
      console.info("Iframe loaded, sending token and instrument data");
      var _a, _b;
      (_a = iframe.contentWindow) === null || _a === void 0 ? void 0 : _a.postMessage({
        type: 'token',
        data: token
      }, iframe.src);
      if (mergedOptions.instrument) {
        (_b = iframe.contentWindow) === null || _b === void 0 ? void 0 : _b.postMessage({
          type: 'instrument',
          data: mergedOptions.instrument
        }, iframe.src);
      }
    });
    return iframe;
  }

</script>

</body>
</html>
